# 第3章：RPC服务核心注解的设计与实现

[toc]

<div class="ql-snow">
            <div class="content ql-editor"><p>作者：冰河</p><p>星球：<a href="http://m6z.cn/6aeFbs" target="_blank">http://m6z.cn/6aeFbs</a></p><p>博客：<a href="https://binghe001.github.io" target="_blank">https://binghe001.github.io</a></p><p>本章对应的代码地址：<a href="https://gitcode.net/l1028386804/bhrpc-learning/-/tree/bhrpc-chapter-03" target="_blank">https://gitcode.net/l1028386804/bhrpc-learning/-/tree/bhrpc-chapter-03</a></p><p><br></p><blockquote><div class="blockquote-item">沉淀，成长，突破，帮助他人，成就自我。</div></blockquote><p><br></p><p><strong>大家好，我是冰河~~</strong></p><p><br></p><p>从本章开始，我们就正式进入《RPC手撸专栏》的手动开发RPC框架源码的章节，哈哈，小伙伴们是不是有点迫不及待了呢？今天我们就正式开始RPC手撸源码的学习。在正式手撸源码之前呢，小伙伴们允许我说一些题外话吧。</p><p><br></p><p>相信很多小伙伴对《RPC手撸专栏》的文章都挺期待了，很多小伙伴在微信和星球上催我更新，还有些小伙伴在语雀文档上催我更新《RPC手撸专栏》。确实，距离上次更新已经过去一个多月了，难免有很多小伙伴会着急什么时候更新剩下的文章。其实，在这一个多月的时间里，冰河一方面是因为公司杂七杂八的事情太多了，有点忙的抽不开身。</p><p><br></p><p>针对与《RPC手撸专栏》来说，冰河其实并没有什么都没做，相反，也做了很多事情，就是为了让《RPC手撸专栏》写的更好，让小伙伴们更加透彻的了解一个成熟的RPC框架是如何一步步设计和开发出来的。</p><p><br></p><h2>一、文章目录</h2><p><br></p><p><img src="https://article-images.zsxq.com/FsvfNa7C9x1ka0NEXDaeBvxBOQly"></p><p><br></p><h2>二、目前的RPC框架</h2><p><br></p><p>目前较为完善的RPC框架项目涵盖60+个子项目了，给大家看看项目的结构吧。</p><p><br></p><p><img src="https://article-images.zsxq.com/Fl6193yho9dCYWk6gbpYQr-WCUn1"></p><p><br></p><p><img src="https://article-images.zsxq.com/FqC7UCiM1TOeknqDLmWjA_OYX1r1"></p><p><br></p><p>目前这60+个子项目并没有包含《RPC手撸专栏》的所有内容，再给大家看看《RPC手撸专栏》涵盖的技术规划吧。</p><p><br></p><p><img src="https://article-images.zsxq.com/FsiGgxmPje7Y4IkEwLL9_aCuzFUh"></p><p><br></p><p>写一个可在实际环境使用的高性能、可扩展、分布式的RPC框架着实不易，项目中会以SPI的形式预留大量的扩展点供各位小伙伴们完善，这样对大家来说更有参与感，也更能通过实际参与项目开发的形式进一步提升自己的技术技能。</p><p><br></p><p>项目中大量使用了SPI机制来提升项目的扩展性，例如，以负载均衡子项目来说，就以SPI机制提供了一致性Hash、最近最少连接数、随机、加权随机、轮询、加权轮询、基于源IP地址的Hash等几种负载均衡方式，大家也可以根据自己的实际需要，通过项目中的SPI机制来定制自己的负载均衡规则，看下面的大图吧。</p><p><br></p><p><img src="https://article-images.zsxq.com/Fi84C2LLlHuiV88K79cxaWeB-rls"></p><p><br></p><p>并且，值得一提的是，RPC项目中采用的RPC机制是完全对标Dubbo项目的，并没有采用Java原生的SPI机制，这些都会带着大家一步步实现。</p><p><br></p><p>好了，真正写好一个成熟的、高性能、可扩展、分布式的RPC框架并不是一件容易的事情，但即使再困难，我们也要一步一个脚印的将其蹚平，RPC该有的功能，我们都会慢慢实现和完善。接下来，我们就一起来完成今天的任务——RPC服务核心注意的定义与解析。</p><p><br></p><h2>三、搭建项目工程</h2><p><br></p><p>很多小伙伴应该都知道，我已经提前写好了RPC框架的很多功能了，并且将框架命名为<code>bhrpc，但是为了不与之前的项目冲突，同时带着大家从零开始手撸这个RPC框架，于是乎，我将带着大家一起手撸这个RPC框架的项目名称改成了bhrpc-learning，bhrpc-learning</code> 这个项目工程是从零开始带着大家一起来实现整个RPC框架的功能，到时这个项目中会预留大量的SPI扩展点供小伙伴们自行实现功能。</p><p><br></p><p><strong>注意：整个项目是基于JDK1.8开发的，其中会涉及到一些JDK1.8中的语法，所以如果小伙伴们使用的JDK版本小于1.8的话，需要将JDK的版本升级到1.8。</strong></p><p><br></p><p>（1）在IDEA中创建一个名称为<code>bhrpc-learning</code> 的Maven项目。</p><p><br></p><p>（2）在项目的pom.xml文件中添加如下的Maven依赖。</p><p><br></p><div class="ql-code-block-container"><div class="ql-code-block"><span class="ql-token hljs-tag">&lt;properties&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;string.version&gt;</span>5.2.20.RELEASE<span class="ql-token hljs-tag">&lt;/string.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;junit.version&gt;</span>4.12<span class="ql-token hljs-tag">&lt;/junit.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;slf4j.version&gt;</span>1.7.21<span class="ql-token hljs-tag">&lt;/slf4j.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;logback.version&gt;</span>1.1.7<span class="ql-token hljs-tag">&lt;/logback.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;common.logging&gt;</span>1.2<span class="ql-token hljs-tag">&lt;/common.logging&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;netty.version&gt;</span>4.1.77.Final<span class="ql-token hljs-tag">&lt;/netty.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;protostuff.version&gt;</span>1.0.8<span class="ql-token hljs-tag">&lt;/protostuff.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;zookeeper.version&gt;</span>3.5.5<span class="ql-token hljs-tag">&lt;/zookeeper.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;curator.version&gt;</span>2.12.0<span class="ql-token hljs-tag">&lt;/curator.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;commons.collections4.version&gt;</span>4.0<span class="ql-token hljs-tag">&lt;/commons.collections4.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;commons.lang3.version&gt;</span>3.12.0<span class="ql-token hljs-tag">&lt;/commons.lang3.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;objenesis.version&gt;</span>2.1<span class="ql-token hljs-tag">&lt;/objenesis.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;cglib.version&gt;</span>3.1<span class="ql-token hljs-tag">&lt;/cglib.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;jackson.version&gt;</span>2.10.0<span class="ql-token hljs-tag">&lt;/jackson.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;javassist.version&gt;</span>3.21.0-GA<span class="ql-token hljs-tag">&lt;/javassist.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;hessian.version&gt;</span>4.0.63<span class="ql-token hljs-tag">&lt;/hessian.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;kyro.version&gt;</span>5.2.0<span class="ql-token hljs-tag">&lt;/kyro.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;fst.version&gt;</span>2.57<span class="ql-token hljs-tag">&lt;/fst.version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;spring.boot.version&gt;</span>2.2.6.RELEASE<span class="ql-token hljs-tag">&lt;/spring.boot.version&gt;</span></div><div class="ql-code-block"><span class="ql-token hljs-tag">&lt;/properties&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block"><span class="ql-token hljs-tag">&lt;dependencies&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-comment">&lt;!-- SLF4J --&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>org.slf4j<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>slf4j-log4j12<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${slf4j.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>commons-logging<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>commons-logging<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${common.logging}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">&lt;!-- &lt;dependency&gt;</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">             &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">             &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">             &lt;version&gt;${logback.version}&lt;/version&gt;</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">         &lt;/dependency&gt;--&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">&lt;!-- Spring --&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>org.springframework<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>spring-context<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${string.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">&lt;!-- Netty --&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>io.netty<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>netty-all<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${netty.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">&lt;!-- Apache Commons Collections --&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>org.apache.commons<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>commons-collections4<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${commons.collections4.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">&lt;!--Apache Commons lang3--&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>org.apache.commons<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>commons-lang3<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${commons.lang3.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">&lt;!-- Objenesis --&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>org.objenesis<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>objenesis<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${objenesis.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">&lt;!-- CGLib --&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>cglib<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>cglib<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${cglib.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>org.javassist<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>javassist<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${javassist.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>jackson-databind<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${jackson.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;dependency&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>jackson-core<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;version&gt;</span>${jackson.version}<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/dependency&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block"><span class="ql-token hljs-tag">&lt;/dependencies&gt;</span></div><div class="ql-code-block"><br></div><div class="ql-code-block"><span class="ql-token hljs-tag">&lt;build&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;plugins&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;plugin&gt;</span></div><div class="ql-code-block">            <span class="ql-token hljs-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="ql-token hljs-tag">&lt;/groupId&gt;</span></div><div class="ql-code-block">            <span class="ql-token hljs-tag">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="ql-token hljs-tag">&lt;/artifactId&gt;</span></div><div class="ql-code-block">            <span class="ql-token hljs-tag">&lt;version&gt;</span>3.6.1<span class="ql-token hljs-tag">&lt;/version&gt;</span></div><div class="ql-code-block">            <span class="ql-token hljs-tag">&lt;configuration&gt;</span></div><div class="ql-code-block">                <span class="ql-token hljs-tag">&lt;source&gt;</span>1.8<span class="ql-token hljs-tag">&lt;/source&gt;</span></div><div class="ql-code-block">                <span class="ql-token hljs-tag">&lt;target&gt;</span>1.8<span class="ql-token hljs-tag">&lt;/target&gt;</span></div><div class="ql-code-block">            <span class="ql-token hljs-tag">&lt;/configuration&gt;</span></div><div class="ql-code-block">        <span class="ql-token hljs-tag">&lt;/plugin&gt;</span></div><div class="ql-code-block">    <span class="ql-token hljs-tag">&lt;/plugins&gt;</span></div><div class="ql-code-block"><span class="ql-token hljs-tag">&lt;/build&gt;</span></div></div><p><br></p><p>这里，为了大家更好的理解，我就直接贴出来了。</p><p><br></p><p>至此，项目的父级工程（顶级工程）就创建完毕了，后续根据实现的功能不同，会在这个工程下创建子工程模块进行实现。</p><p><br></p><h2>四、核心注解的设计</h2><p><br></p><p>大家可以试想一下，一个完整的RPC框架其实是包含四个大的部分，分别是服务提供者、服务消费者、注册中心和监控中心。</p><p><br></p><p><img src="https://article-images.zsxq.com/Ft83e_Rh9BFbz6EcBS_pdVimjKJq"></p><p><br></p><p>而对于RPC的注解设计来说，往往最核单独心的就是设计服务提供者和服务消费者的注解。接下来，我们就对服务提供者和服务消费者的注解进行针对性的设计。</p><p><br></p><h3>4.1 设计服务提供者注解</h3><p><br></p><p>服务提供者是要注册到注册中心的，那么注册到注册中心中的数据，也就是通常所说的注册到注册中心的元数据包含哪些呢？这里，大家其实可以认真的思考下。</p><p><br></p><h4>4.1.1 服务提供者注解设计的逻辑</h4><p><br></p><p>一个极简的服务提供者注册到注册中心的元数据应该包含如下几部分：服务名称、服务版本号、服务地址、服务端口号、服务分组信息。</p><p><br></p><ol><li data-list="bullet"><span class="ql-ui"></span>服务名称：服务的名称往往是提供服务的接口的完整类名。</li><li data-list="bullet"><span class="ql-ui"></span>服务版本号：标识当前服务的版本号，以版本号的形式来区分不同版本所提供的不同服务。</li><li data-list="bullet"><span class="ql-ui"></span>服务地址：服务提供者发布的服务所在的网络地址，往往是一个IP地址或者域名。</li><li data-list="bullet"><span class="ql-ui"></span>服务端口号：服务提供者发布的服务所监听的端口号。</li><li data-list="bullet"><span class="ql-ui"></span>服务分组：对不同的服务进行分组，达到服务隔离的效果。</li></ol><p><br></p><p>接下来，我们再次思考下，其实对于一个应用程序来说，启动后一个应用程序监听一个IP地址/域名和端口就足够了，而不需要为同一个应用程序中的每一个RPC服务都单独去监听一个IP地址/域名和端口，我们只需要为服务提供者所在的项目工程统一配置服务监听的IP地址/域名和端口号即可。又因为对于一个较完备的RPC框架来说，需要支持多种不同的注册中心，同时，针对同一个服务提供者来说，往往会将其服务统一注册到同一种类型的注册中心上，所以，注册中心的地址和类型以及负载均衡类型也都可以在项目工程中统一配置。</p><p><br></p><p>所以，在我们设计的服务提供者的注解中，可以不包含服务地址和服务端口号。</p><p><br></p><p><strong>大家可以再仔细思考下，为什么不需要在注解中提供服务地址和服务端口号。</strong></p><p><br></p><p><strong>所以，在我们设计的服务提供者注解中就只剩下了服务名称、服务版本号和服务分组三个核心属性，并且这三个核心属性可以确定一个唯一的服务提供者。</strong></p><p><br></p><h4>4.1.2 服务提供者注解设计的实现</h4><p><br></p><p>确定好服务提供者注解设计的逻辑后，接下来就是编码实现了，在<code>bhrpc-learning工程下创建一个名称为bhrpc-annotation</code> 的子工程模块，服务提供者和服务消费者的核心注解就放在这个工程模块中。</p><p><br></p><p>接下来，在<code>bhrpc-annotation工程模块中创建 io.binghe.rpc.annotation Java包，在 io.binghe.rpc.annotation</code>  包中创建服务提供者的核心注解类RpcService，代码如下所示。</p><p><br></p><div class="ql-code-block-container"><div class="ql-code-block"><span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment"> * @author binghe</span></div><div class="ql-code-block"><span class="ql-token hljs-comment"> * @version 1.0.0</span></div><div class="ql-code-block"><span class="ql-token hljs-comment"> * @description bhrpc服务提供者注解</span></div><div class="ql-code-block"><span class="ql-token hljs-comment"> */</span></div><div class="ql-code-block"><span class="ql-token hljs-meta">@Target({ElementType.TYPE})</span></div><div class="ql-code-block"><span class="ql-token hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></div><div class="ql-code-block"><span class="ql-token hljs-meta">@Component</span></div><div class="ql-code-block"><span class="ql-token hljs-keyword">public</span> <span class="ql-token hljs-meta">@interface</span> RpcService {</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 接口的Class</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    Class&lt;?&gt; interfaceClass() <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-keyword">void</span>.class;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 接口的ClassName</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">interfaceClassName()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">""</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 版本号</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">version()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">"1.0.0"</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 服务分组，默认为空</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">group()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">""</span>;</div><div class="ql-code-block">}</div></div><p><br></p><p>可以看到，RpcService注解的实现基本上和之前的分析逻辑一致，只不过针对与服务的名称，也就是实现服务的接口的完整类名，这里定义了两个属性，一个是interfaceClass属性，一个是interfaceClassName属性。</p><p><br></p><h4>4.1.3 服务提供者注解使用样例</h4><p><br></p><p>如果使用interfaceClass属性的话，使用的注解形式如下所示。</p><p><br></p><div class="ql-code-block-container"><div class="ql-code-block"><span class="ql-token hljs-meta">@RpcService(interfaceClass=BingheService.class, version="1.0.0", group = "binghe")</span></div><div class="ql-code-block"><span class="ql-token hljs-keyword">public</span> <span class="ql-token hljs-keyword">class</span> <span class="ql-token hljs-title">BingheServiceImpl</span> <span class="ql-token hljs-keyword">implements</span> <span class="ql-token hljs-title">BingheService</span>{</div><div class="ql-code-block">    <span class="ql-token hljs-comment">//此处省略</span></div><div class="ql-code-block">}</div></div><p><br></p><p>如果使用interfaceClassName属性的话，就需要标注实现服务的接口的完整类名，使用的注解形式如下所示。</p><p><br></p><div class="ql-code-block-container"><div class="ql-code-block"><span class="ql-token hljs-meta">@RpcService(interfaceClassName="io.binghe.rpc.demo.service.BingheService", version="1.0.0", group="binghe")</span></div><div class="ql-code-block"><span class="ql-token hljs-keyword">public</span> <span class="ql-token hljs-keyword">class</span> <span class="ql-token hljs-title">BingheServiceImpl</span> <span class="ql-token hljs-keyword">implements</span> <span class="ql-token hljs-title">BingheService</span>{</div><div class="ql-code-block">    <span class="ql-token hljs-comment">//此处省略</span></div><div class="ql-code-block">}</div></div><p><br></p><p><strong>另外，需要注意的是服务提供者注解@RpcService是标注到实现类上的。</strong></p><p><br></p><p>至此，服务提供者的注解就设计并实现完毕了。</p><p><br></p><h3>4.2 设计服务消费者注解</h3><p><br></p><p>服务消费者相对服务提供者来说要复杂一些，所以，服务消费者的设计比服务提供者的设计也会复杂一些。因为RPC框架中需要实现的同步调用、异步调用、回调和单向调用等等，往往都是需要在服务消费者一侧实现，这就导致服务消费者的设计要比服务提供者的设计复杂的多。</p><p><br></p><p>注意：有关RPC调用方式（同步调用、异步调用、回调和单向调用）的具体说明，可以参见《<a href="https://articles.zsxq.com/id_xvd5up1u16nx.html" target="_blank">《RPC手撸专栏》第2章：高性能分布式RPC框架整体架构设计</a>》一文的内容。</p><p><br></p><h4>4.1.1 服务消费者注解设计的逻辑</h4><p><br></p><p>一个极简的服务消费者注解需要包含如下几个部分：</p><p><br></p><ol><li data-list="bullet"><span class="ql-ui"></span>注册中心地址：服务消费者需要从注册中心中订阅服务提供者的信息。</li><li data-list="bullet"><span class="ql-ui"></span>注册中心的类型：由于RPC框架需要支持不同类型的注册中心，所以在服务消费者中需要配置服务的注册中心类型。</li><li data-list="bullet"><span class="ql-ui"></span>负载均衡类型：当具备多个服务提供者时，服务消费者需要实现负载均衡，在多个服务提供者中选择一个有效的服务提供者进行调用。</li><li data-list="bullet"><span class="ql-ui"></span>版本号：与服务提供者对应，只有服务名称、服务版本号、服务分组与服务提供者都匹配时，才能调用到服务提供者相应的服务。</li><li data-list="bullet"><span class="ql-ui"></span>服务分组：与服务提供者对应，只有服务名称、服务版本号、服务分组与服务提供者都匹配时，才能调用到服务提供者相应的服务。</li><li data-list="bullet"><span class="ql-ui"></span>序列化类型：服务消费者调用服务提供者的服务时，数据需要在网络中进行传输，这就涉及到数据的序列化方式。</li><li data-list="bullet"><span class="ql-ui"></span>超时时间：服务消费者调用服务提供者的服务时，为避免一直阻塞，造成服务性能低下的问题，这里根据实际情况可以设置超时时间。</li><li data-list="bullet"><span class="ql-ui"></span>是否异步调用：一个较为完备的RPC框架，需要在服务消费者一侧实现同步和异步调用。</li><li data-list="bullet"><span class="ql-ui"></span>是否单向调用：一个较为完备的RPC框架，需要在服务消费者一侧实现是否是单向调用。</li><li data-list="bullet"><span class="ql-ui"></span>代理方式：在服务消费者一侧需要实现根据不同的代理方式来对远程的服务提供者发起调用。</li></ol><p><br></p><p><strong>这里，大家有没有发现，在服务消费者的注解中并没有包含服务的名称，同时在服务消费者的注解中包含了注册中心地址、注册中心类型和负载均衡类型，而服务提供者中的注册中心地址、注册中心类型和负载均衡类型都在项目工程中统一设置的。这是为什么呢？</strong></p><p><br></p><p>其实，服务消费者需要调用的服务提供者发布的服务名称，是从注册中心中获取的，所以，在服务消费者中不用配置服务名称。</p><p><br></p><p>另外，是RPC框架的服务消费者的实现中，支持在项目工程中统一配置注册中心地址、注册中心类型和负载均衡类型，但是考虑到作为服务消费者，可能要调用不同项目工程实现的服务提供者发布的RPC服务，不同项目工程的服务提供者可能使用的注册中心类型不同，也就是使用了不同的注册中心，<strong>所以，在实现RPC框架的服务消费者时，这里不仅支持在项目工程中统一配置注册中心地址、注册中心类型和负载均衡类型，还支持在注解中针对具体的服务不同，配置不同的注册中心地址、注册中心类型和负载均衡类型。这是区别于其他RPC框架的一大亮点。</strong></p><p><br></p><h4>4.1.2 服务消费者注解设计的实现</h4><p><br></p><p>在<code>bhrpc-annotation 工程模块的 io.binghe.rpc.annotation</code> 包下创建RpcReference注解类，代码如下所示。</p><p><br></p><div class="ql-code-block-container"><div class="ql-code-block"><span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment"> * @author binghe</span></div><div class="ql-code-block"><span class="ql-token hljs-comment"> * @version 1.0.0</span></div><div class="ql-code-block"><span class="ql-token hljs-comment"> * @description bhrpc服务消费者</span></div><div class="ql-code-block"><span class="ql-token hljs-comment"> */</span></div><div class="ql-code-block"><span class="ql-token hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></div><div class="ql-code-block"><span class="ql-token hljs-meta">@Target(ElementType.FIELD)</span></div><div class="ql-code-block"><span class="ql-token hljs-meta">@Autowired</span></div><div class="ql-code-block"><span class="ql-token hljs-keyword">public</span> <span class="ql-token hljs-meta">@interface</span> RpcReference {</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 版本号</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">version()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">"1.0.0"</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 注册中心类型, 目前的类型包含：zookeeper、nacos、etcd、consul</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">registryType()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">"zookeeper"</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 注册地址</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">registryAddress()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">"127.0.0.1:2181"</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 负载均衡类型，默认基于ZK的一致性Hash</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">loadBalanceType()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">"zkconsistenthash"</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 序列化类型，目前的类型包含：protostuff、kryo、json、jdk、hessian2、fst</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">serializationType()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">"protostuff"</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 超时时间，默认5s</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    <span class="ql-token hljs-type">long</span> <span class="ql-token hljs-title">timeout()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-number">5000</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 是否异步执行</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    <span class="ql-token hljs-type">boolean</span> <span class="ql-token hljs-title">async()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-literal">false</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 是否单向调用</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    <span class="ql-token hljs-type">boolean</span> <span class="ql-token hljs-title">oneway()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-literal">false</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 代理的类型，jdk：jdk代理， javassist: javassist代理, cglib: cglib代理</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">proxy()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">"jdk"</span>;</div><div class="ql-code-block"><br></div><div class="ql-code-block">    <span class="ql-token hljs-comment">/**</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     * 服务分组，默认为空</span></div><div class="ql-code-block"><span class="ql-token hljs-comment">     */</span></div><div class="ql-code-block">    String <span class="ql-token hljs-title">group()</span> <span class="ql-token hljs-keyword">default</span> <span class="ql-token hljs-string">""</span>;</div><div class="ql-code-block">}</div></div><p><br></p><p>这里，我们实现的服务消费者注解@RpcReference中的属性与设计的逻辑一致。</p><p><br></p><p><strong>另外，需要注意的是服务消费者的注解@RpcReference是标注到字段上的。</strong></p><p><br></p><h4>4.1.3 服务消费者使用样例</h4><p><br></p><p>我们可以按照如下的形式使用服务消费者的注解@RpcReference。</p><p><br></p><div class="ql-code-block-container"><div class="ql-code-block"><span class="ql-token hljs-meta">@Service</span> <span class="ql-token hljs-comment">//Spring的@Service注解</span></div><div class="ql-code-block"><span class="ql-token hljs-keyword">public</span> <span class="ql-token hljs-keyword">class</span> <span class="ql-token hljs-title">ConsumerServiceImpl</span> <span class="ql-token hljs-keyword">implements</span> <span class="ql-token hljs-title">ConsumerService</span>{</div><div class="ql-code-block">    <span class="ql-token hljs-meta">@RpcReference(registryType = "zookeeper", registryAddress = "127.0.0.1:2181", loadBalanceType = "zkconsistenthash", version = "1.0.0", group = "binghe", serializationType = "protostuff", proxy = "cglib", timeout = 30000, async = true, oneway=false)</span></div><div class="ql-code-block">    <span class="ql-token hljs-keyword">private</span> BingheService bingheService;</div><div class="ql-code-block">     <span class="ql-token hljs-comment">//此处省略</span></div><div class="ql-code-block">}</div></div><p><br></p><p>可以看到，作为使用样例，我们在BingheService上使用的@RpcReference注解几乎涵盖了注解的所有属性，在实际使用的过程中，由于 @RpcReference注解中提供了部分属性的默认值，如果实际环境与@RpcReference注解的默认值相同的话，大家可以根据实际情况省略部分注解属性的配置。</p><p><br></p><p>例如，例如，使用的注册中心是Zookeeper，并且Zookeeper与服务消费者部署在同一台服务器，同时使用的负载均衡类型为zkconsistenthash，序列化类型为protostuff，代理类型为cglib，超时时间为5秒，不是异步调用，也不是单向调用。这样，这些配置和@RpcReference注解中提供的属性值相同。</p><p><br></p><p>那么可以按照如下方式进行配置。</p><p><br></p><div class="ql-code-block-container"><div class="ql-code-block"><span class="ql-token hljs-meta">@Service</span> <span class="ql-token hljs-comment">//Spring的@Service注解</span></div><div class="ql-code-block"><span class="ql-token hljs-keyword">public</span> <span class="ql-token hljs-keyword">class</span> <span class="ql-token hljs-title">ConsumerServiceImpl</span> <span class="ql-token hljs-keyword">implements</span> <span class="ql-token hljs-title">ConsumerService</span>{</div><div class="ql-code-block">    <span class="ql-token hljs-meta">@RpcReference(version = "1.0.0", group = "binghe")</span></div><div class="ql-code-block">    <span class="ql-token hljs-keyword">private</span> BingheService bingheService;</div><div class="ql-code-block">     <span class="ql-token hljs-comment">//此处省略</span></div><div class="ql-code-block">}</div></div><p><br></p><p>至此，大家学会如何分析和设计RPC框架的核心注解了吗？</p><p><br></p><h2>五、本章总结</h2><p><br></p><p>本章主要带着大家详细分析了RPC框架的核心注解@RpcService和@RpcReference的设计逻辑和实现，以及简单列举了在项目中如何使用@RpcService注解发布RPC服务和使用@RpcReference注解订阅服务。</p><p><br></p><p>希望本章的内容能够为大家带来实质性的帮助。</p><p><br></p><h2>六、一点点建议</h2><p><br></p><p>咱们这个专栏属于实战类型比较强的专栏，加上咱们一起从零开始手撸的RPC框架会涉及众多的知识点。正所谓纸上得来终觉浅，绝知此事要躬行。冰河希望大家在学习这个专栏的时候勤动手，跟着专栏一起实现代码。期间要多动脑，多总结，这样才能够加深对各项知识点的理解。切忌眼高手低，学了半天却最终啥也没学会。</p><p><br></p><p><strong>好了，今天的文章就到这儿吧，如果文章对你有点帮助，记得给冰河一键三连哦，欢迎将文章转发给更多的小伙伴，冰河将不胜感激~~</strong></p><p><br></p><h2>七、关于星球</h2><p><br></p><p>我会将《RPC手撸专栏》的源码获取方式放到知识星球中，同时在微信上会创建专门的知识星球群，冰河会在知识星球上和星球群里解答球友的提问。</p><p><br></p><p>还没上车的小伙伴赶紧啦，<strong>星球的球友们正在一起手撸可用于实际场景的高性能RPC框架</strong>，再不上车就跟不上啦！！</p><p><br></p><h3>星球提供的服务</h3><p><br></p><p>冰河整理了星球提供的一些服务，如下所示。</p><p><br></p><p>加入星球，你将获得： </p><p><br></p><p>1.学习从零开始手撸可用于实际场景的高性能、可扩展、分布式的RPC框架项目</p><p><br></p><p>2.学习SpringCloud Alibaba实战项目—从零开发微服务项目 </p><p><br></p><p>3.学习高并发、大流量业务场景的解决方案，体验大厂真正的高并发、大流量的业务场景 </p><p><br></p><p>4.学习进大厂必备技能：性能调优、并发编程、分布式、微服务、框架源码、中间件开发、项目实战 </p><p><br></p><p>5.提供站点 https://binghe001.github.io 所有学习内容的指导、帮助 </p><p><br></p><p>6.GitHub：https://github.com/binghe001/BingheGuide - 非常有价值的技术资料仓库，包括冰河所有的博客开放案例代码 </p><p><br></p><p>7.可以发送你的简历到我的邮箱，提供简历批阅服务 </p><p><br></p><p>8.提供技术问题、系统架构、学习成长、晋升答辩等各项内容的回答 </p><p><br></p><p>9.定期的整理和分享出各类专属星球的技术小册、电子书、编程视频、PDF文件 </p><p><br></p><p>10.定期组织技术直播分享，传道、授业、解惑，指导阶段瓶颈突破技巧</p><p><br></p><h3>如何加入星球</h3><p><br></p><ol><li data-list="bullet"><span class="ql-ui"></span><strong>链接</strong> ：打开链接 <a href="http://m6z.cn/6aeFbs" target="_blank">http://m6z.cn/6aeFbs</a> 加入星球。</li><li data-list="bullet"><span class="ql-ui"></span><strong>回复</strong> ：在公众号 <strong>冰河技术</strong> 回复 <strong>星球</strong> 领取优惠券加入星球。</li></ol><p><br></p><p><strong>特别提醒：</strong> 苹果用户进圈或续费，请加微信 <strong>hacker_binghe</strong> 扫二维码，或者去公众号 <strong>冰河技术</strong> 回复 <strong>星球</strong> 扫二维码加入星球。</p><p><br></p><p><strong>好了，今天就到这儿吧，我是冰河，我们下期见~~</strong></p></div>
        </div>